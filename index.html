<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Predator Bumi - Solo & Upgrade</title>
<style>
    /* ... (Style lama tetap ada) ... */
    
    .leaderboard-container { 
        background: #111; margin: 15px auto; width: 90%; max-width: 380px; 
        border-radius: 15px; border: 1px solid #444; overflow: hidden;
    }
    .lb-header { background: #222; padding: 8px; font-size: 0.8rem; font-weight: bold; color: gold; }
    .lb-list { padding: 5px; font-size: 0.85rem; }
    .lb-row { display: flex; justify-content: space-between; padding: 5px 10px; border-bottom: 1px solid #222; }
    .lb-row:last-child { border: none; }
    .lb-rank { color: #888; width: 25px; }
    .lb-name { flex-grow: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .lb-dmg { color: #ff4444; font-weight: bold; }
</style>

<div class="leaderboard-container">
    <div class="lb-header">üèÜ TOP 5 PREDATOR DUNIA</div>
    <div id="lbList" class="lb-list">
        <div style="padding:10px; color:#555;">Memuat peringkat...</div>
    </div>
</div>

<script type="module">
    // ... (Import Firebase tetap sama) ...
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, doc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    // ... (Config tetap sama) ...
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const predatorName = localStorage.getItem('solo_uid') || "Predator";
    const myPower = parseInt(localStorage.getItem('last_power')) || 1;
    const globalRef = doc(db, "world", "earth");
    let isExploding = false;
    let localLastHit = 0;

    // Tampilkan Nama & Power
    document.getElementById('pName').innerText = predatorName;
    document.getElementById('pPower').innerText = myPower.toLocaleString();

    onSnapshot(globalRef, (snap) => {
        if(!snap.exists()) return;
        const d = snap.data();
        
        // 1. Update Populasi & Hit Animasi
        document.getElementById('globalPop').innerText = d.population.toLocaleString('id-ID');
        if (d.last_hit && d.last_hit !== localLastHit) {
            localLastHit = d.last_hit;
            // ... (Animasi shake & spawnDmg tetap sama) ...
        }

        // 2. UPDATE LEADERBOARD (Real-time & Irit)
        const lbList = document.getElementById('lbList');
        if (d.leaderboard) {
            // Urutkan dari damage paling besar & ambil 5 teratas
            const sortedLB = d.leaderboard.sort((a, b) => b.totalDmg - a.totalDmg).slice(0, 5);
            lbList.innerHTML = sortedLB.map((player, index) => `
                <div class="lb-row">
                    <span class="lb-rank">#${index + 1}</span>
                    <span class="lb-name">${player.name}</span>
                    <span class="lb-dmg">${player.totalDmg.toLocaleString()}</span>
                </div>
            `).join('');
        }
        
        // 3. Logic Ledakan Reset ... (Tetap sama)
    });

    document.getElementById('raidBtn').onclick = async () => {
        if (isExploding) return;

        // Ambil data terbaru dulu untuk update leaderboard array
        // (Atau pake trik update array di database biar gak nambah read)
        try {
            // Kita pake logic: Cek apakah nama kita sudah ada di array d.leaderboard
            // Karena updateDoc array itu agak tricky, cara paling irit buat lo:
            // Simpan total damage lokal dulu atau biarkan server-side (tapi ini tier gratis)
            
            // Cara Gampang: Update stat hit aja, Leaderboard biar urusan arrayUnion
            // Tapi karena kita mau "Hemat", kita update total damage per user di dokumen earth
            
            // Logic: Kita kirim hit, lalu di database kita update object dalam array
            // Untuk pemula, paling gampang adalah nambahin field baru di dokumen earth:
            // "stats_NamaUser": totalDamage
            
            await updateDoc(globalRef, { 
                population: increment(-myPower),
                last_hit: Date.now(),
                last_dmg: myPower,
                last_name: predatorName
            });

            // Update Leaderboard: Kita akalin pake penambahan damage ke array
            // (Catatan: Ini butuh logic d.leaderboard di onSnapshot tadi buat update balik)
            updateLeaderboardData(predatorName, myPower);

        } catch (e) { console.log(e); }
    };

    async function updateLeaderboardData(name, dmg) {
        // Ambil data saat ini
        const earthSnap = await getDoc(globalRef); // Butuh import getDoc
        if (earthSnap.exists()) {
            let lb = earthSnap.data().leaderboard || [];
            const userIdx = lb.findIndex(u => u.name === name);
            
            if (userIdx > -1) {
                lb[userIdx].totalDmg += dmg;
            } else {
                lb.push({ name: name, totalDmg: dmg });
            }
            
            // Update balik ke Firebase
            await updateDoc(globalRef, { leaderboard: lb });
        }
    }
</script>


</body>
</html>
